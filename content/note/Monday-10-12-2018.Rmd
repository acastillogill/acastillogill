---
title: "Adding population"
subtitle: "Correlation between population and internet users?"
author: √Ångela Castillo-Gill
date: '2018-12-10'
slug: adding-population
categories:
  - Journal
tags: 
  - Learning
draft: FALSE
summary: "Correlation between population and internet users?"
output:
 blogdown::html_page:
  fig_caption: true
editor_options: 
  chunk_output_type: console
---

```{r setup, echo=FALSE, message=FALSE}
library(dplyr)
library(knitr)
library(here)
library(scales)
library(magrittr)
library(ggplot2)
library(cowplot)
library(tidyverse)
opts_chunk$set(echo = TRUE,
               warning = FALSE,
               error = FALSE,
               message = FALSE,
               collapse= TRUE,
               comment = NA,
               tidy = TRUE)
theme_set(theme_light())

options(
  ggplot2.discrete.colour = "viridis",
  ggplot2.discrete.fill = "viridis",
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis",
  digits=2,
  scipen = 999
)

r_downloads <- readRDS(file=here::here("static","data","r-downloads.rds"))
```



[Data source](https://github.com/rfordatascience/tidytuesday/tree/master/data/2018-10-30)

```{r downloads-by-country}
r_downloads%>%
  group_by(country)%>%
  summarise(n=n())%>%
  arrange(desc(n))->downloads_per_country
```

Now I'm going to give the countries full names, to do this I will use the ISO code to merge and obtain names. 

```{r read-country-codes}
iso_codes <- read_csv(here("static","data","iso_countries.csv"))
```

```{r merge-country-codes}
downloads_per_country%<>%
  right_join(iso_codes, by=c("country"="iso"))
```


## Which are the top ten countries in terms of downloads
```{r top-20-countries-plot}
downloads_per_country%>%
  arrange(desc(n))%>%
  filter(!is.na(name))%>%
  head(20)%>%
  mutate(name=fct_reorder(name,n))%>%
  ggplot(aes(name,n,fill=name))+
  geom_col()+
  expand_limits(y=0)+
  coord_flip()+
  scale_y_continuous(labels=comma_format())+
  labs(title="Top 20 countries by R downloads",
       x="Country",
       y="Downloads")+
  theme(legend.position = "none")
  
```
Today I've added one variable `internet_users` which sums the total internet users per country. The point is to slowly add regressors or independent variables and see if they have a linear relationship with `r-downloads`. If yes, I'll add them to a model.

```{r read-internet-users}
internet_users <-read_csv(here("static","data","internet_users.csv"))
```

```{r merge-internet-users}
downloads_users_country <-downloads_per_country%>%
  right_join(internet_users, by=c("name"="name"))%>%
  filter(!is.na(name),
         !is.na(users),
         !is.na(n))%>%
  arrange(desc(n))
  
```

```{r downloads-internet-users-scatter-plot, fig.cap="There are clearly some influential points, US, China and India, that are outliers in case of a regression."}
library(plotly)
downloads_internet_plot<- downloads_users_country%>%
  arrange(desc(n))%>%
  ggplot(aes(users, n, label=name, color=region))+
  #Add light opacity
  geom_jitter()+
  #Add nice commas x axis
  scale_x_continuous(labels=comma_format())+
  #Add nice commas y axis
scale_y_continuous(labels=comma_format())+
  #Add a linear regression line for all regions
  geom_smooth(aes(group=1),method="lm")+
  #Fix legend
theme(legend.position = "bottom", legend.title = element_blank())+
   #Add title
  labs(title="Do R-Language downloads increase with more internet users?",
       y="Downloads per country",
       x="Internet users in each country")
  

ggplotly(downloads_internet_plot)%>%
   layout(legend = list(orientation = "h", x = 0.4, y = -0.2))
```



```{r dataset-without-outliers}
downloads_users_country%>%
  filter(name!="United Kingdom",
         name!="Germany",
         name!="China",
         name!="India",
         name!="United States of America",
         name!="Brazil",
         name!="Japan",
         name!="Canada",
         name!="Australia",
         name!="Namibia")->outliers_gone
```


```{r plot-without-outliers}
downloads_internet_plot_out<- outliers_gone%>%
  arrange(desc(n))%>%
  ggplot(aes(users, n, label=name, color=region))+
  #Add light opacity
  geom_jitter()+
  #Add nice commas x axis
  scale_x_continuous(labels=comma_format())+
  #Add nice commas y axis
scale_y_continuous(labels=comma_format())+
  #Add a linear regression line for all regions
  geom_smooth(aes(group=1),method="lm")+
  #Fix legend
theme(legend.position = "bottom", legend.title = element_blank())+
   #Add title
  labs(title="Do R-Language downloads increase with more internet users?",
       subtitle = "China, India, United Kingdom, and Germany removed.",
       y="Downloads per country",
       x="Internet users in each country")
  

ggplotly(downloads_internet_plot_out)%>%
   layout(legend = list(orientation = "h", x = 0.4, y = -0.2))
```


As I was removing outliers yesterday, I was thinking, what do all these countries I'm removing have in common and what variable can I add to capture some of that variability.

I mean, look at them, United Kingdom, Germany, China, India, USA, Brazil, Japan, Canada, Australia, Namibia... They are in almost all cases "developed" countries. Let's add the Human Development Indicator as a variable to see if it can capture some of that variability. 

```{r read-hdi-index}
human_dev_ind <-read_csv(here("static","data","HDI.csv"))
```


```{r merge-hdi-users}
downloads_hdi_country <-downloads_users_country%>%
  right_join(human_dev_ind, by=c("name"="name"))%>%
  arrange(desc(HDI))%>%
  filter(!is.na(name),
         !is.na(users),
         !is.na(n),
         !is.na(HDI))
```

```{r hdi-downloads-plot}
downloads_hdi_plot<- downloads_hdi_country%>%
  ggplot(aes(x=HDI, y=n, label=name, color=region))+
  #Add light opacity
  geom_jitter()+
  #Add nice commas x axis
  scale_x_continuous(labels=percent_format())+
  #Add nice commas y axis
scale_y_continuous(labels=comma_format())+
  #Add a linear regression line for all regions
  geom_smooth(aes(group=1),method="lm")+
  #Fix legend
theme(legend.position = "bottom", legend.title = element_blank())+
   #Add title
  labs(title="Human Development Index (HDI) and R downloads.",
       y="Downloads per country",
       x="Human Development Index")

ggplotly(downloads_hdi_plot)
```

Wow! There does seem to be a strong linear relationship between the variables. Now, it might be that countries with more internet users also have a higher human development index. Makes sense? Right? Let me check the correlation:

```{r checking-correlation}
cor(downloads_hdi_country$users,downloads_hdi_country$HDI)*100
```

Hmmmm only 8% I thought it would be higher. Multicollinearity is a threat in regression. Why add another variable that whose explanatory variable is contained in another.

Let me see the model with this new variable in:

```{r fitting-hdi-users}
internet_fit <- lm(n ~ users, data=downloads_hdi_country)
hdi_fit <- lm(n ~ users + HDI, data=downloads_hdi_country)
summary(hdi_fit)$coef
```

So the HDI is a significant variable if our Type error rate is 0.05, but barely. Internet users still is top.
```{r diagnostics-hdi-users}
par(mfrow=c(2,2))
plot(hdi_fit)
```

Wow! They bloody residuals look not that bad. For like the first time ever in my experience! There is more or less equal variation around zero, they do look more or less distributed normally, and of course we have some outliers, we always do. I'm not too inclined to add another variable. Let's look at the adjusted $R^2$.

```{r}
summary(hdi_fit)$adj.r.squared*100
```

Mmmm, those two variables, internet users and the HDI only explain about 20.53% of the variation. I want to increase the explanatory power of the model, what to do?

So today I would like break up the HDI index into its component parts and see how each separate feature relates to R downloads. 

The HDI is a mix of three elements: 

- Health: Life expectancy (years)
- Education: Expected years of schooling(years)/Mean years of schooling (years)
- Standard of living: Gross national income per capita (2011 PPP $)

So I have downloaded those variables and I will now plot them against downloads and also fit the regression model again. 

```{r read-three-new-indicators}
standard_liv <- read_csv(here("static","data","GNIPC.csv"))
standard_liv$GNI <- as.integer(standard_liv$GNI)

life_exp <- read_csv(here("static","data","life_exp.csv"))
edu_year <- read_csv(here("static","data","edu_year.csv"))
pop <-read_csv(here("static","data","country_populations.csv"))
edu_year <- edu_year%>%
  filter(Indicator=="Mean years of schooling (ISCED 1 or higher), population 25+ years, both sexes",
         year==2016)%>%
  select(country,educ)
```


```{r join-new-indicators}
full_hdi <- downloads_hdi_country%>%
  left_join(pop, by=c("name"="name"))%>%
  left_join(standard_liv, by=c(`alpha-3`="iso"))%>%
  left_join(life_exp, by=c(`country-code`="country_code"))%>%
  left_join(edu_year, by=c(`alpha-3`="country"))%>%
  arrange(name)
```

```{r life-exp-plot}
life_exp_plot<- full_hdi%>%
  ggplot(aes(x=life_exp, y=n, label=name, color=region))+
  #Add light opacity
  geom_jitter(alpha=0.3)+
  #Add nice commas y axis
scale_y_continuous(labels=comma_format())+
  #Add a linear regression line for all regions
  geom_smooth(aes(group=1),method="lm")+
  #Remove legend
  theme(legend.position = "none")+
   #Add title
  labs(title="Life expectancy at birth and R downloads.",
       y="Downloads per country",
       x="Life expectancy at birth (Years)")

```

```{r educ-plot}
educ_plot<- full_hdi%>%
  ggplot(aes(x=educ, y=n, label=name, color=region))+
  #Add light opacity
  geom_jitter(alpha=0.3)+
  #Add nice commas y axis
scale_y_continuous(labels=comma_format())+
  #Add a linear regression line for all regions
  geom_smooth(aes(group=1),method="lm")+
  #Fix legend
theme(legend.position = "bottom", legend.title = element_blank())+
   #Add title
  labs(title="Mean years of schooling (years) and R downloads.",
       y="Downloads per country",
       x="Mean years of schooling (years)")

```

```{r GNI_plot}
GNI_plot<- full_hdi%>%
  ggplot(aes(x=GNI, y=n, label=name, color=region))+
  #Add light opacity
  geom_jitter(alpha=0.3)+
    #Add nice commas x axis
  scale_x_continuous(labels=dollar_format())+
  #Add nice commas y axis
scale_y_continuous(labels=comma_format())+
  #Add a linear regression line for all regions
  geom_smooth(aes(group=1),method="lm")+
  #Remove legend
  theme(legend.position = "none")+
   #Add title
  labs(title="Gross National Income and R downloads.",
       y="Downloads per country",
       x="Gross National Income")

```

```{r plot-three-HDI}
plot_grid(life_exp_plot, educ_plot, GNI_plot)
```


```{r four-var-fit}
four_fit <- lm(n ~ users + GNI + educ + life_exp, data=full_hdi)
summary(four_fit)$coef
```

Seems like separating the four doesn't lead to any significant coefficients beyond internet users. Interesting. I leave `HDI` in and it does, barely. I wonder what's behind the number of internet users... 

```{r population-fit}
pop_fit <- lm(n ~ pop_2018 + HDI, data=full_hdi, na.action = na.omit)
summary(pop_fit)$coef
```

I added population as a variable, now since multicollinearity is a threat, that is adding variables that are highly correlated amongst themselves is as issue, I tested the correlation between internet users and population and it was `r cor(full_hdi$users,full_hdi$pop_2018, use = "pairwise.complete.obs")*100`. It's high. Because of this, I have to choose using either population or internet users. I fitted the model again with `HDI` and `pop_2018` and the adjusted R Squared is `r summary(pop_fit)$adj.r.squared*100`. With population instead of internet users, the model explains `r (summary(hdi_fit)$adj.r.squared-summary(pop_fit)$adj.r.squared)*100` less of the variation in the data.

So far, with all the variables I've tried so far, inclusion of the Human Development Index and internet users per country most explain variation in the data.

I wonder if I nested models by region... I wonder if that would change something. Interesting to try. I'll do this and then write it up.

```{r nesting-models}
library(broom)

nested_hdi <- full_hdi%>%
  group_by(region)%>%
  nest()

```

```{r mean-downloads-per-region}
downloads_nested <- nested_hdi %>%
  mutate(mean_n = map_dbl(data, ~mean(.x$n)))

# Extract the mean_n value by using unnest
downloads_mean <- downloads_nested %>% 
  unnest(mean_n)
```

```{r linear-model-for-each-region}
regression_each_region <- nested_hdi %>%
  mutate(model=map(data, ~lm(formula=n~HDI+users, data=.x)))
```

```{r extracting-coefficients}
# Extract the coefficient statistics of each model into nested dataframes
model_coef_nested <- regression_each_region %>% 
    mutate(coef = map(model, ~tidy(.x)))
    
# Simplify the coef dataframes for each model    
model_coef <- model_coef_nested %>%
    unnest(coef)

```

```{r assessing-model-fit}
# Extract the fit statistics of each model into dataframes
model_perf_nested <- regression_each_region %>% 
    mutate(fit = map(model, ~glance(.x)))

# Simplify the fit dataframes for each model    
model_perf <- model_perf_nested %>% 
    unnest(fit)

# Look at the first six rows of model_perf
head(model_perf)
```


```{r ranking fit}
# Plot a histogram of rsquared for the 77 models    
model_perf %>% 
  ggplot(aes(x = r.squared)) + 
  geom_histogram()
  
# Extract the 4 best fitting models
best_fit <- model_perf %>% 
  top_n(n = 2, wt = r.squared)

# Extract the 4 models with the worst fit
worst_fit <- model_perf %>% 
  top_n(n = 2, wt = -r.squared)
```

```{r visualising-model-fit}
best_augmented <- best_fit %>% 
  # Build the augmented dataframe for each country model
  mutate(augmented = map(model, ~augment(.x))) %>% 
  # Expand the augmented dataframes
  unnest(augmented)

worst_augmented <- worst_fit %>% 
  # Build the augmented dataframe for each country model
  mutate(augmented = map(model, ~augment(.x))) %>% 
  # Expand the augmented dataframes
  unnest(augmented)
```

```{r best-mods}
# Compare the predicted values with the actual values of life expectancy 
# for the top 4 best fitting models
best_augmented %>% 
  ggplot(aes(x = HDI)) +
  geom_point(aes(y = n)) + 
  geom_line(aes(y = .fitted), color = "red") +
  facet_wrap(~region, scales = "free_y")
```

```{r worst-mods}
worst_augmented %>% 
  ggplot(aes(x = HDI)) +
  geom_point(aes(y = n)) + 
  geom_line(aes(y = .fitted), color = "red") +
  facet_wrap(~region, scales = "free_y")
```

