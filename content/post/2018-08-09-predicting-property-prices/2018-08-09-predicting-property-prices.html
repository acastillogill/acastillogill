---
title: Predicting property prices
author: Ángela Castillo-Gill
date: '2018-08-09'
slug: predicting-property-prices
categories:
  - R
  - RPART
tags: 
  - Kaggle
  - Home sales prices
draft: FALSE
summary: What factors most affect sales prices for homes?
header: 
  image: ""
  caption: "Test"
output:
  blogdown::html_page:
    toc: true
    number_sections: true
    toc_depth: 2
  fig_caption: true
editor_options: 
  chunk_output_type: console
---

<script src="/rmarkdown-libs/kePrint/kePrint.js"></script>

<div id="TOC">
<ul>
<li><a href="#summary"><span class="toc-section-number">1</span> Summary</a></li>
<li><a href="#business-quesiton"><span class="toc-section-number">2</span> Business quesiton</a></li>
<li><a href="#dataset-description"><span class="toc-section-number">3</span> Dataset description</a></li>
<li><a href="#steps"><span class="toc-section-number">4</span> Steps</a></li>
<li><a href="#result"><span class="toc-section-number">5</span> Result</a></li>
<li><a href="#interpretation"><span class="toc-section-number">6</span> Interpretation</a></li>
</ul>
</div>

<div id="summary" class="section level1">
<h1><span class="header-section-number">1</span> Summary</h1>
<p><em>To see the code used in this post, visit my <a href="https://www.kaggle.com/adcastillogill/exploring-kiva-loans">kernel on kaggle in R Markdown format</a>.</em></p>
</div>
<div id="business-quesiton" class="section level1">
<h1><span class="header-section-number">2</span> Business quesiton</h1>
</div>
<div id="dataset-description" class="section level1">
<h1><span class="header-section-number">3</span> Dataset description</h1>
<p>The dataset <a href="https://www.kaggle.com/c/house-prices-advanced-regression-techniques">House Prices: Advanced Regression Techniques</a> was downloaded from Kaggle and put together by <a href="https://ww2.amstat.org/publications/jse/v19n3/decock.pdf">Dean De Cock.</a> It has 79 explanatory variables describing 1,460 homes in Ames, Iowa. The codebook for all the variables can be <a href="https://www.kaggle.com/c/house-prices-advanced-regression-techniques/data">found here.</a> As I go along, I’ll explain the most relevant ones.</p>
<p>First we will see how many numerical vs. categorical variables there are.</p>
<p>Our dataset has 38 numeric and 43 character variables. Next, since we are interested in estimating sales prices <code>SalePrice</code>, we will recode character variables and see the most strongly correlated variables. There are 43 character variables available. I want to recode them where there is ordinality and where there isn’t dummify them.</p>
<p>There are two numerical variables that are actually date related: <code>YearBuilt</code> and <code>YearRemodAdd</code> (remodelled date). It makes more sense to make two new variables that relate the build and remodelled dates with the present. In other words, I will create the years since built and years since remodelled date variables, this will help interpret the results better.
# Motivation for tool</p>
<p>The tool that I’m going to be using to solve is a regression tree. It’s known as as classification and regression trees (CART) or the recursing and partitioning (RPART) algorithm.</p>
<p>The reason I’m choosing this tool or algorithm to answer the business question is because regression trees are interpretable and we can make easy to follow plots with them.</p>
<p>It will be implemented with the <code>rpart</code> package in R.</p>
<p>Rpart, builds a model in two stages:</p>
<p><strong>First stage</strong>:</p>
<p>A single variable is identified which can best <a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> split the data into two groups. The data is then separated intwo two groups and the whole process is repeated <em>recursively</em> or indefinitely until the sub-groups reach a minimum size, or until no further improvements can be made.</p>
<p><a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>: The best tree is the smallest tree with highest cross-validated error.</p>
<p>When the split is made, similarity amongst the observations can more or less homogenous. This homogeneity is also called purity and it can be measured. The impurity measure of a node specifies how mixed the resulting subset is.</p>
<p><strong>Second stage</strong>:</p>
<p>The tree is trimmed back or prunned using cross-validation.</p>
</div>
<div id="steps" class="section level1">
<h1><span class="header-section-number">4</span> Steps</h1>
<div id="missing-values" class="section level4">
<h4><span class="header-section-number">4.0.0.1</span> Missing values</h4>
<p>As it more common than not, the dataset contains missing values. Missing values need to be dealt with because regression (and other models) requires complete observations.</p>
<p>Dealing with missing data depends on <em>why the data are missing</em>. <a href="http://www.stat.columbia.edu/~gelman/arm/missing.pdf">This article</a> explains four reasons why data could be missing. When the data are missing at random (MAR) or completely at random (MCAR), observations with missing values can be removed without introducing bias into the model.</p>
<p>Sometimes, however, if the dataset is not too big and we don’t want to lose observations, or even if it is big, yet we still don’t want to remove observations, we can impute data. Imputing means replacing missing values by doing some educated guesses. <a href="https://towardsdatascience.com/how-to-handle-missing-data-8646b18db0d4">This article</a> summarises how to impute data depending on why it is missing.</p>
<p>If the data are not missing at random, then the imputation mechanism has to modelled.</p>
<p>Let’s look at which variables are missing:</p>
<table class="table table-striped table-hover table-condensed" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:missigness-table">Table 4.1: </span>Variables with missing values in descending order
</caption>
<thead>
<tr>
<th style="text-align:left;">
Variable
</th>
<th style="text-align:right;">
Number of NAs
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
PoolQC
</td>
<td style="text-align:right;">
1453
</td>
</tr>
<tr>
<td style="text-align:left;">
MiscFeature
</td>
<td style="text-align:right;">
1406
</td>
</tr>
<tr>
<td style="text-align:left;">
Alley
</td>
<td style="text-align:right;">
1369
</td>
</tr>
<tr>
<td style="text-align:left;">
Fence
</td>
<td style="text-align:right;">
1179
</td>
</tr>
<tr>
<td style="text-align:left;">
FireplaceQu
</td>
<td style="text-align:right;">
690
</td>
</tr>
<tr>
<td style="text-align:left;">
LotFrontage
</td>
<td style="text-align:right;">
259
</td>
</tr>
<tr>
<td style="text-align:left;">
GarageType
</td>
<td style="text-align:right;">
81
</td>
</tr>
<tr>
<td style="text-align:left;">
GarageYrBlt
</td>
<td style="text-align:right;">
81
</td>
</tr>
<tr>
<td style="text-align:left;">
GarageFinish
</td>
<td style="text-align:right;">
81
</td>
</tr>
<tr>
<td style="text-align:left;">
GarageQual
</td>
<td style="text-align:right;">
81
</td>
</tr>
<tr>
<td style="text-align:left;">
GarageCond
</td>
<td style="text-align:right;">
81
</td>
</tr>
<tr>
<td style="text-align:left;">
BsmtExposure
</td>
<td style="text-align:right;">
38
</td>
</tr>
<tr>
<td style="text-align:left;">
BsmtFinType2
</td>
<td style="text-align:right;">
38
</td>
</tr>
<tr>
<td style="text-align:left;">
BsmtQual
</td>
<td style="text-align:right;">
37
</td>
</tr>
<tr>
<td style="text-align:left;">
BsmtCond
</td>
<td style="text-align:right;">
37
</td>
</tr>
<tr>
<td style="text-align:left;">
BsmtFinType1
</td>
<td style="text-align:right;">
37
</td>
</tr>
<tr>
<td style="text-align:left;">
MasVnrType
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:left;">
MasVnrArea
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:left;">
Electrical
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
<p>19 variables have missing values. Based on the codebook, the reason why so many houses have <code>PoolQC</code> missing is because <code>NA</code>, means there is no pool. Since this variable is ordinal, I can revalue it to make it numerical and <code>0</code> will mean the property has no pool. <code>MiscFeature</code>, <code>Alley</code>, <code>Fence</code>, and <code>FireplaceQu</code> are missing because of similar reasons. We don’t know why <code>LotFrontage</code> is missing but we will impute as the median for properties in the same neighborhood. <a href="https://www.kaggle.com/erikbruin/house-prices-lasso-xgboost-and-a-detailed-eda/code">Erik Bruin’s kernel on Kaggle</a> with this dataset, was a great guideline for what to do in each missing value case.</p>
</div>
<div id="variable-creation" class="section level4">
<h4><span class="header-section-number">4.0.0.2</span> Variable creation</h4>
<p><img src="/post/2018-08-09-predicting-property-prices/2018-08-09-predicting-property-prices_files/figure-html/understanding-neighborhood-var-1.png" width="672" /></p>
</div>
<div id="correlation" class="section level4">
<h4><span class="header-section-number">4.0.0.3</span> Correlation</h4>
<p>Correlation, <span class="math inline">\(Cor(X,Y)\)</span>, measures the strength of the linear relationship between two variables <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>.</p>
<p>The correlation between <code>SalePrice</code> and another variable, let’s say, <code>OverallQual</code>, is the covariance of the separately normalised data between the two variables.</p>
<pre class="r"><code>cov(scale(homes$SalePrice), scale(homes$OverallQual))
          [,1]
[1,] 0.7909816</code></pre>
<p>Since covariance units are <code>OverallQual</code> * <code>SalePrice</code>, calculating the correlation is instead more helpful since it is unit free.</p>
<p>If we created a model with only variable as the predictor of <code>SalesPrice</code>, let’s say, <code>KitchenQual</code> and normalised the data, the regression slope would be the correlation between the two variables.</p>
<pre class="r"><code>norm_fit &lt;- lm(scale(SalePrice) ~ scale(KitchenQual), data = homes)
round(coefficients(norm_fit), digits = 2)
       (Intercept) scale(KitchenQual) 
              0.00               0.66 </code></pre>
<p>Here is the correlation matrix for variables that have a relationship stronger than 0.5 with <code>SalePrice</code>.</p>
<p><img src="/post/2018-08-09-predicting-property-prices/2018-08-09-predicting-property-prices_files/figure-html/correlation-matrix-1.png" width="672" /></p>
<p>There are 17 variables that have a correlation stronger than 0.5. They are arranged in descending order. It is interesting to note the high correlation that exists amongst variables. The correlation plot highlights some obvious ones, <code>GarageArea</code> and <code>GarageCars</code>. Makes sense, a bigger garage can hold more cars. <code>X1stFlrSF</code> and <code>TotalBsmtSF</code>, the total area of the first floor and basement, this also seems reasonable since basements are underneath the same floor and would tend to have a similar area. <code>TotRmsAbvGrd</code> and <code>GrLivArea</code>, the total number of rooms and area above ground, again ok, more rooms would be linked to a bigger living area. Finally, <code>YearsSinceBuilt</code> and <code>YearsSinceGarageBuilt</code> since garages are usually built at the same time as the house.</p>
<p>Here is the codebook for all the variables featured in the correlation matrix in case they come up later and we need to interpret what they mean.</p>
<p><strong>Positive correlation</strong></p>
<ul>
<li><code>OverallQual</code>: Rates the overall material and finish of the house</li>
<li><code>GrLivArea</code>: Above grade (ground) living area square feet.</li>
<li><code>ExterQual</code>: Exterior quality</li>
<li><code>KitchenQual</code>: Kitchen quality</li>
<li><code>GarageCars</code>: Size of garage in car capacity</li>
<li><code>GarageArea</code>: Size of garage in square feet</li>
<li><code>TotalBsmtSF</code>: Total square feet of basement area</li>
<li><code>X1stFlrSF</code>: First floor square feet</li>
<li><code>BsmtQual</code>: Height of basement</li>
<li><code>FullBath</code>: Full bathrooms above grade</li>
<li><code>GarageFinish</code>: Interior finish of the garage</li>
<li><code>TotRmsAbvGrd</code>: Total rooms above grade (does not include bathrooms)</li>
<li><code>FireplaceQu</code>: Fireplace quality</li>
</ul>
<p><strong>Negative correlation</strong></p>
<ul>
<li><code>YearsSinceRemod</code>: Years since remodel date (same as construction date if no remodelling or additions)</li>
<li><code>YearsSinceGarageBuilt</code>: Years since the garage was built</li>
<li><code>YearsSinceBuilt</code>: Years since construction date</li>
</ul>
</div>
<div id="splitting-the-data" class="section level4">
<h4><span class="header-section-number">4.0.0.4</span> Splitting the data</h4>
</div>
<div id="training-the-model" class="section level4">
<h4><span class="header-section-number">4.0.0.5</span> Training the model</h4>
</div>
<div id="revising-variable-importance" class="section level4">
<h4><span class="header-section-number">4.0.0.6</span> Revising variable importance</h4>
<table class="table table-striped table-hover table-condensed" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:variable-importance-table">Table 4.2: </span>Top 30 variables in order of importance
</caption>
<thead>
<tr>
<th style="text-align:left;">
Variable
</th>
<th style="text-align:right;">
Percentage
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
OverallQual
</td>
<td style="text-align:right;">
23.2881205
</td>
</tr>
<tr>
<td style="text-align:left;">
BsmtQual
</td>
<td style="text-align:right;">
9.3219127
</td>
</tr>
<tr>
<td style="text-align:left;">
TotalBsmtSF
</td>
<td style="text-align:right;">
9.2963511
</td>
</tr>
<tr>
<td style="text-align:left;">
GarageCars
</td>
<td style="text-align:right;">
8.9148899
</td>
</tr>
<tr>
<td style="text-align:left;">
GarageArea
</td>
<td style="text-align:right;">
8.3353758
</td>
</tr>
<tr>
<td style="text-align:left;">
Neighborhood_type
</td>
<td style="text-align:right;">
5.5795851
</td>
</tr>
<tr>
<td style="text-align:left;">
KitchenQual
</td>
<td style="text-align:right;">
5.3419024
</td>
</tr>
<tr>
<td style="text-align:left;">
GrLivArea
</td>
<td style="text-align:right;">
4.9671386
</td>
</tr>
<tr>
<td style="text-align:left;">
X1stFlrSF
</td>
<td style="text-align:right;">
3.9252303
</td>
</tr>
<tr>
<td style="text-align:left;">
FullBath
</td>
<td style="text-align:right;">
3.7461030
</td>
</tr>
<tr>
<td style="text-align:left;">
YearsSinceBuilt
</td>
<td style="text-align:right;">
3.7244438
</td>
</tr>
<tr>
<td style="text-align:left;">
YearsSinceGarageBuilt
</td>
<td style="text-align:right;">
3.0305361
</td>
</tr>
<tr>
<td style="text-align:left;">
Foundation
</td>
<td style="text-align:right;">
2.6912965
</td>
</tr>
<tr>
<td style="text-align:left;">
TotRmsAbvGrd
</td>
<td style="text-align:right;">
2.0111251
</td>
</tr>
<tr>
<td style="text-align:left;">
MSSubClass
</td>
<td style="text-align:right;">
1.1734153
</td>
</tr>
<tr>
<td style="text-align:left;">
BsmtFinSF1
</td>
<td style="text-align:right;">
1.0429523
</td>
</tr>
<tr>
<td style="text-align:left;">
BsmtUnfSF
</td>
<td style="text-align:right;">
0.8111851
</td>
</tr>
<tr>
<td style="text-align:left;">
X2ndFlrSF
</td>
<td style="text-align:right;">
0.7053916
</td>
</tr>
<tr>
<td style="text-align:left;">
HouseStyle
</td>
<td style="text-align:right;">
0.6331315
</td>
</tr>
<tr>
<td style="text-align:left;">
LotArea
</td>
<td style="text-align:right;">
0.4572123
</td>
</tr>
<tr>
<td style="text-align:left;">
LotFrontage
</td>
<td style="text-align:right;">
0.3740828
</td>
</tr>
<tr>
<td style="text-align:left;">
MSZoning
</td>
<td style="text-align:right;">
0.1799967
</td>
</tr>
<tr>
<td style="text-align:left;">
BedroomAbvGr
</td>
<td style="text-align:right;">
0.1711556
</td>
</tr>
<tr>
<td style="text-align:left;">
BsmtCond
</td>
<td style="text-align:right;">
0.0714405
</td>
</tr>
<tr>
<td style="text-align:left;">
BsmtExposure
</td>
<td style="text-align:right;">
0.0714405
</td>
</tr>
<tr>
<td style="text-align:left;">
BsmtFinType1
</td>
<td style="text-align:right;">
0.0714405
</td>
</tr>
<tr>
<td style="text-align:left;">
Id
</td>
<td style="text-align:right;">
0.0315722
</td>
</tr>
<tr>
<td style="text-align:left;">
RoofStyle
</td>
<td style="text-align:right;">
0.0315722
</td>
</tr>
</tbody>
</table>
</div>
<div id="evaluating-the-model" class="section level4">
<h4><span class="header-section-number">4.0.0.7</span> Evaluating the model</h4>
<pre><code>[1] 46893.56
[1] 31678.89</code></pre>
</div>
<div id="tuning-hyperparameters" class="section level4">
<h4><span class="header-section-number">4.0.0.8</span> Tuning hyperparameters</h4>
<p><img src="/post/2018-08-09-predicting-property-prices/2018-08-09-predicting-property-prices_files/figure-html/tuning-hyperparameters-1.png" width="672" /></p>
<pre><code>           CP nsplit rel error    xerror       xstd
1  0.44576120      0 1.0000000 1.0034376 0.09648934
2  0.11362733      1 0.5542388 0.5578944 0.05448931
3  0.07787835      2 0.4406115 0.4760270 0.05459581
4  0.03461959      3 0.3627331 0.4091012 0.03666288
5  0.02116148      4 0.3281135 0.3979878 0.04568692
6  0.01818931      5 0.3069520 0.4082587 0.04732241
7  0.01742778      6 0.2887627 0.3937271 0.04468678
8  0.01671704      7 0.2713350 0.3939984 0.04468230
9  0.01294838      8 0.2546179 0.3677683 0.04291999
10 0.01000000      9 0.2416695 0.3524860 0.04281097</code></pre>
<p><img src="/post/2018-08-09-predicting-property-prices/2018-08-09-predicting-property-prices_files/figure-html/tuning-hyperparameters-2.png" width="672" /></p>
</div>
<div id="checking-the-error-on-the-optimised-model" class="section level4">
<h4><span class="header-section-number">4.0.0.9</span> Checking the error on the optimised model</h4>
<pre><code>[1] 49963.95
[1] 33909.8</code></pre>
</div>
</div>
<div id="result" class="section level1">
<h1><span class="header-section-number">5</span> Result</h1>
</div>
<div id="interpretation" class="section level1">
<h1><span class="header-section-number">6</span> Interpretation</h1>
<ul>
<li></li>
</ul>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>1<a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p>1<a href="#fnref2" class="footnote-back">↩</a></p></li>
</ol>
</div>
