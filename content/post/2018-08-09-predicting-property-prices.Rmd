---
title: Predicting property prices
author: √Ångela Castillo-Gill
date: '2018-08-09'
slug: predicting-property-prices
categories:
  - R
  - EDA
tags: 
  - Kaggle
  - Home sales prices
draft: FALSE
summary: What factors most affect sales prices for homes?
output:
  blogdown::html_page:
    toc: true
    number_sections: true
    toc_depth: 2
  fig_caption: true
editor_options: 
  chunk_output_type: inline
---


```{r setup, include=FALSE}
x <-
  c("tidyverse",
    "knitr",
    "formatR",
    "stringr",
    "quantmode",
    "skimr",
    "lubridate",
    "tidyr",
    "formattable",
    "grid",
    "gridExtra",
    "kableExtra",
    "here",
    "corrplot",
    "rms",
    "dummies")

lapply(x, require, character.only = TRUE)


opts_chunk$set(echo = FALSE,
               warning = FALSE,
               error = FALSE,
               message = FALSE,
               collapse= TRUE,
               comment = NA,
               tidy = TRUE)

#Clear Global Environment
rm(list = ls())
```

# Summary

*To see the code used in this post, visit my [kernel on kaggle in R Markdown format](https://www.kaggle.com/adcastillogill/exploring-kiva-loans).* 



# Purpose of this post



# The data

The dataset [House Prices: Advanced Regression Techniques](https://www.kaggle.com/c/house-prices-advanced-regression-techniques) was downloaded from Kaggle and put together by [Dean De Cock.](https://ww2.amstat.org/publications/jse/v19n3/decock.pdf) It has 79 explanatory variables describing 1,460 homes in Ames, Iowa. The codebook for all the variables can be [found here.](https://www.kaggle.com/c/house-prices-advanced-regression-techniques/data) As I go along, I'll explain the most releveant ones. 


```{r results='hide', message=FALSE}
path <- "/Volumes/TOSHIBAEXT/RStudio/blog/content/post/house_prices/"
#Read `train.csv` as homes
homes <- read.csv(paste0(path,"train.csv"), stringsAsFactors = FALSE)
```

```{r results='hide'}
#Get a glimpse of homes
glimpse(homes)
```

First we will see how many numerical vs. categorical variables there are. 
```{r counting variable types}
#is.numeric returns TRUE if the variable is numeric. 
#sapply iterates and returns a vector. 
#Which gives the indices that were TRUE
num_var <- which(sapply(homes, is.numeric))
#Count how many variables are numeric
length_num_var <- length(num_var)
#Return a vector with character variables
car_var <- which(sapply(homes, is.character))
#Count how many variables are characters
length_car_var <- length(car_var)
```

Our dataset has `r length_num_var` numeric and `r length_car_var` character variables. Next, since we are interested in estimating sales prices `SalePrice`, we will recode character variables and see the most strongly correlated variables. There are 43 character variables available. I want to recode them where there is ordinality and where there isn't dummify them.

There are two numerical variables that are actually date related: `YearBuilt`and `YearRemodAdd` (remodelled date). It makes more sense to make two new variables that relate the build and remodelled dates with the present. In other words, I will create the years since built and years since remodelled date variables, this will help interpret the results better. 

```{r}
homes<-homes%>%
  #Mutate to create `YearsSinceBuilt`, `YearsSinceGarageBuilt`, and `YearsSinceRemod`
  #It will be the difference of the present year - YearBuilt
  mutate(YearsSinceBuilt = year(Sys.Date())-YearBuilt,
         #Same for YearsSinceRemod
         YearsSinceRemod = year(Sys.Date())-YearRemodAdd,
         #Same for GarageYrBlt
         YearsSinceGarageBuilt = year(Sys.Date())-GarageYrBlt)%>%
  #Remove `YearsSinceBuilt`, `YearsSinceGarageBuilt`, and `YearsSinceRemod`
  select(-YearBuilt,
         -YearRemodAdd,
         -GarageYrBlt,
         -Id)
```



```{r}
#Which variables have missingness in data

homes%>%
  select_if(function (x) any(is.na(x)))%>%
  summarise_each(funs(sum(is.na(.))))%>%
  gather()%>%
  arrange(desc(value))->missing_columns

missing_columns%>%
#Make table
  kable(caption="Variables with missing values in descending order",
        #Add column names
        col.names = c("Variable","Number of NAs")) %>%
  #Style table
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

`r nrow(missing_columns)` variables have missing values. 

```{r missingness and recoding ordinal variables}

#Vector for ordinal values
ordinal_scale <- c("Ex"=5, "Gd"=4, "TA"=3, "Fa"=2, "Po"=1, "No"=0)

#Missingness PoolQC
homes$PoolQC[is.na(homes$PoolQC)] <- "No"

#Recode PoolQC
homes$PoolQC<-as.integer(plyr::revalue(homes$PoolQC, ordinal_scale))

#Missingness MiscFeature
homes$MiscFeature[is.na(homes$MiscFeature)] <- "No"

#Recode MiscFeature
homes$MiscFeature <- as.factor(homes$MiscFeature)

#Missingness Alley
homes$Alley[is.na(homes$Alley)] <- "No"

#Recode Alley
homes$Alley <- as.factor(homes$Alley)

#Missingness Fence
homes$Fence[is.na(homes$Fence)] <- "No"

#Checking if Fence is ordinal
homes%>%
  filter(!is.na(SalePrice))%>%
  group_by(Fence) %>%
  summarise(median = median(SalePrice), counts=n())

#Fence is not ordinal

#Recode Fence
homes$Fence <- as.factor(homes$Fence)

#Missingness FireplaceQu
homes$FireplaceQu[is.na(homes$FireplaceQu)] <- "No"

#Checking if FireplaceQu is ordinal
homes%>%
  filter(!is.na(SalePrice))%>%
  group_by(FireplaceQu) %>%
  summarise(median = median(SalePrice), counts=n())

#Recode FireplaceQu
homes$FireplaceQu<-as.integer(plyr::revalue(homes$FireplaceQu, ordinal_scale))


#LotFrontage is the linear feet of street connnected to property
#Missing values will be replaced by neighborhood average

for (i in 1:nrow(homes)){
        if(is.na(homes$LotFrontage[i])){
               homes$LotFrontage[i] <-
                 as.integer(median(homes$LotFrontage[homes$Neighborhood==homes$Neighborhood[i]], na.rm=TRUE)) 
        }
}

#Missingness GarageType
homes$GarageType[is.na(homes$GarageType)] <- "No"

#Recode GarageType
homes$GarageType <- as.factor(homes$GarageType)

#Checking if GarageFinish is ordinal
homes%>%
  filter(!is.na(SalePrice))%>%
  group_by(GarageFinish) %>%
  summarise(median = median(SalePrice), counts=n())

#It is ordinal

#Missingness GarageFinish
homes$GarageFinish[is.na(homes$GarageFinish)] <- "No"

#GarageFinish ordinal vector
Finish <- c('No'=0, 'Unf'=1, 'RFn'=2, 'Fin'=3)

#Recode GarageFinish
homes$GarageFinish<-as.integer(plyr::revalue(homes$GarageFinish, Finish))
table(homes$GarageFinish)

#Missingness GarageQual
homes$GarageQual[is.na(homes$GarageQual)] <- "No"

#Recode GarageQual
homes$GarageQual<-as.integer(plyr::revalue(homes$GarageQual, ordinal_scale))

#Missingness GarageCond
homes$GarageCond[is.na(homes$GarageCond)] <- "No"

#Recode GarageCond
homes$GarageCond<-as.integer(plyr::revalue(homes$GarageCond, ordinal_scale))


```


```{r eval=FALSE}
complete_cor <- homes_num%>%
#Compute correlation of complete observations
   cor(use = "pairwise.complete.obs")

#Make the correlation matrix a tibble
complete_cor_tibble <- as.tibble(as.table(complete_cor))

complete_cor_tibble %>%
  #Sort the tibble by descending correlations
  arrange(desc(n))%>%
  #Filter variables that have an absolute value correlation higher than 0.5 with SalePrice
  filter(Var1=="SalePrice"&abs(n)>0.5&Var2!="SalePrice")%>%
  #Select variable and correlation
  dplyr::select(Var2,n)%>%
  #Make table
  kable(caption="Top 14 correlations with SalePrice",
        #Add column names
        col.names = c("Variable","Correlation")) %>%
  #Style table
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```


# Data exploration

First we will check that there is no multicolinearity amongst highly correlated variables. *explain here what is multicolinearity*.

```{r eval=FALSE}
#Make a simple model
simple_model <- lm(SalePrice ~ OverallQual + GrLivArea + GarageCars + GarageArea + TotalBsmtSF + X1stFlrSF + FullBath + BsmtQualEx + TotRmsAbvGrd + YearsSinceBuilt + YearsSinceRemod + KitchenQualEx + KitchenQualTA + ExterQualTA, data = homes_num)

#Checking for multicolinearity
vif(simple_model)
```

We can see that the variables related to garage show some signs of multicolinearity so I will take out `GarageCars`. 

```{r eval=FALSE}
#Make a corrected_model
corrected_model <- lm(SalePrice ~ OverallQual + GrLivArea + GarageArea + TotalBsmtSF + X1stFlrSF + FullBath + BsmtQualEx + TotRmsAbvGrd + YearsSinceBuilt + YearsSinceRemod + KitchenQualEx + KitchenQualTA + ExterQualTA, data = homes_num)

#Checking for multicolinearity
vif(corrected_model)
```

After removing predictors that were related amongst themselves, the top 13 variables most (above 0.5) correlated are: 

**Positive correlation**

- `OverallQual`: Rates the overall material and finish of the house
- `GarageArea`: Size of garage in square feet
- `TotalBsmtSF`: Total square feet of basement area
- `X1stFlrSF`: First Floor square feet
- `FullBath`: Full bathrooms above grade
- `BsmtQualEx`: Height of basement 100+ inches
- `TotRmsAbvGrd`: Total rooms above grade (does not include bathrooms)
- `KitchenQualEx`: Excellent kitchen quality

**Negative correlation**

- `YearsSinceRemod`: Years since remodel date (same as construction date if no remodelling or additions)
_ `KitchenQualTA`: Typical/Average kitchen quality
- `YearsSinceBuilt`: Years since construction date
- `ExterQualTA`: Typical/Average quality of the material on the exterior 


We will inspect scatter plots against the response variable `SalePrice`. 

```{r eval=FALSE}
#Select significant variables
high_cor_vars <- homes_num%>%
  dplyr::select(OverallQual,
                GarageArea,
                TotalBsmtSF,
                X1stFlrSF,
                FullBath,
                BsmtQualEx,
                TotRmsAbvGrd,
                YearsSinceBuilt,
                YearsSinceRemod,
                KitchenQualEx,
                KitchenQualTA,
                ExterQualTA,
                -GarageCars)

#Create name list of high_cor_vars
names_high_cor_vars <- names(high_cor_vars)
```



```{r high-cor-geompoint, eval=FALSE} 

#For each variable that is highly correlated
for (var in names_high_cor_vars){
  
#ggplot with the dataframe with values
plot <- ggplot(high_cor_vars, aes_string(x=var, y=homes_num$SalePrice))+
#geom_point to see distribution
    geom_jitter(alpha=0.1)+
#Add labels
    labs(title=paste("Sales price vs.",var),
       x=var,
       y="Sales price")+ theme_minimal()+
#Add neat scales for price
scale_y_continuous(breaks= seq(0, 800000, by=100000),
                   labels = comma)

#Print the plot after each loop
print(plot)

}

```

Some numeric variables can actually be better interpreted as factors, these are: `OverallQual`, `FullBath`, `TotRmsAbvGrd`, `BsmtQualEx`, `KitchenQualEx`, `KitchenQualTA`, and `ExterQualTA`.

```{r high-cor-factors, eval=FALSE}
#Save column names
cols <- c("OverallQual", "FullBath", "TotRmsAbvGrd", "BsmtQualEx", "KitchenQualEx", "KitchenQualTA", "ExterQualTA")
#Convert OverallQual, FullBath and TotRmsAbvGrd to a factor
high_cor_vars[cols] <- lapply(high_cor_vars[cols], factor)
```


```{r eval=FALSE}

#Select significant numeric values
high_cor_vars_fact <- high_cor_vars%>%
  dplyr::select(cols)

#Create name list of high_cor_vars
names_high_cor_vars_fact <- names(high_cor_vars_fact)

#For each variable that is highly correlated
for (var in names_high_cor_vars_fact){
  
#ggplot with the dataframe with values
plot <- ggplot(high_cor_vars_fact, aes_string(x=var, y=homes_num$SalePrice))+
#geom_point to see distribution
    geom_boxplot(alpha=0.1)+
#Add labels
    labs(title=paste("Sales price vs.",var),
       x=var,
       y="Sales price") + theme_minimal() +
#Add neat scales for price
scale_y_continuous(breaks= seq(0, 800000, by=100000),
                   labels = comma)

#Print the plot after each loop
print(plot)

} 

```

```{r eval=FALSE}
complete_cor <- homes_num%>%
  select(-GrLivArea)%>%
#Compute correlation of complete observations
   cor(use = "pairwise.complete.obs")

#Make the correlation matrix a tibble
complete_cor_tibble <- as.tibble(as.table(complete_cor))

complete_cor_tibble %>%
  #Sort the tibble by descending correlations
  arrange(desc(n))%>%
  #Filter variables that have an absolute value correlation higher than 0.5 with SalePrice
  filter(Var1=="SalePrice"&abs(n)>0.5&Var2!="SalePrice")%>%
  #Select variable and correlation
  dplyr::select(Var2,n)%>%
  #Make table
  kable(caption="Top 12 correlations with SalePrice",
        #Add column names
        col.names = c("Variable","Correlation")) %>%
  #Style table
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```


# Techniques used

- I 
# Questions from this analysis

- 

