---
title: Predicting property prices
author: √Ångela Castillo-Gill
date: '2018-08-09'
slug: predicting-property-prices
categories:
  - R
  - EDA
tags: 
  - Kaggle
  - Home sales prices
draft: FALSE
summary: What factors most affect sales prices for homes?
output:
  blogdown::html_page:
    toc: true
    number_sections: true
    toc_depth: 2
  fig_caption: true
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
x <-
  c("tidyverse",
    "knitr",
    "formatR",
    "stringr",
    "quantmode",
    "skimr",
    "lubridate",
    "tidyr",
    "formattable",
    "grid",
    "gridExtra",
    "kableExtra",
    "here",
    "corrplot",
    "rms",
    "dummies",
    "sjmisc",
    "car")

lapply(x, require, character.only = TRUE)


opts_chunk$set(echo = FALSE,
               warning = FALSE,
               error = FALSE,
               message = FALSE,
               collapse= TRUE,
               comment = NA,
               tidy = TRUE)

#Clear Global Environment
rm(list = ls())
```

# Summary

*To see the code used in this post, visit my [kernel on kaggle in R Markdown format](https://www.kaggle.com/adcastillogill/exploring-kiva-loans).* 



# Purpose of this post



# The data

The dataset [House Prices: Advanced Regression Techniques](https://www.kaggle.com/c/house-prices-advanced-regression-techniques) was downloaded from Kaggle and put together by [Dean De Cock.](https://ww2.amstat.org/publications/jse/v19n3/decock.pdf) It has 79 explanatory variables describing 1,460 homes in Ames, Iowa. The codebook for all the variables can be [found here.](https://www.kaggle.com/c/house-prices-advanced-regression-techniques/data) As I go along, I'll explain the most releveant ones. 


```{r reading data, results='hide'}
path <- "/Volumes/TOSHIBAEXT/RStudio/blog/content/post/house_prices/"
#Read `train.csv` as homes
homes <- read.csv(paste0(path,"train.csv"), stringsAsFactors = FALSE)
```

First we will see how many numerical vs. categorical variables there are. 
```{r counting variable types}
#is.numeric returns TRUE if the variable is numeric. 
#sapply iterates and returns a vector. 
#Which gives the indices that were TRUE
num_var <- which(sapply(homes, is.numeric))
#Count how many variables are numeric
length_num_var <- length(num_var)
#Return a vector with character variables
car_var <- which(sapply(homes, is.character))
#Count how many variables are characters
length_car_var <- length(car_var)
```

Our dataset has `r length_num_var` numeric and `r length_car_var` character variables. Next, since we are interested in estimating sales prices `SalePrice`, we will recode character variables and see the most strongly correlated variables. There are 43 character variables available. I want to recode them where there is ordinality and where there isn't dummify them.

There are two numerical variables that are actually date related: `YearBuilt`and `YearRemodAdd` (remodelled date). It makes more sense to make two new variables that relate the build and remodelled dates with the present. In other words, I will create the years since built and years since remodelled date variables, this will help interpret the results better. 



```{r missigness-table}

#Which variables have missingness in data
homes%>%
  dplyr::select_if(function (x) any(is.na(x)))%>%
  dplyr::summarise_all(funs(sum(is.na(.))))%>%
  gather()%>%
  arrange(desc(value))->missing_columns

missing_columns%>%
#Make table
  kable(caption="Variables with missing values in descending order",
        #Add column names
        col.names = c("Variable","Number of NAs")) %>%
  #Style table
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

`r nrow(missing_columns)` variables have missing values. 

```{r missingness and recoding ordinal variables, results='hide'}

#Vector for ordinal values
ordinal_scale <- c("Ex"=5, "Gd"=4, "TA"=3, "Fa"=2, "Po"=1, "No"=0)

#Missingness PoolQC
homes$PoolQC[is.na(homes$PoolQC)] <- "No"

#Recode PoolQC
homes$PoolQC<-as.integer(plyr::revalue(homes$PoolQC, ordinal_scale))

#Missingness MiscFeature
homes$MiscFeature[is.na(homes$MiscFeature)] <- "No"

#Recode MiscFeature
homes$MiscFeature <- as.factor(homes$MiscFeature)

#Missingness Alley
homes$Alley[is.na(homes$Alley)] <- "No"

#Recode Alley
homes$Alley <- as.factor(homes$Alley)

#Missingness Fence
homes$Fence[is.na(homes$Fence)] <- "No"

#Checking if Fence is ordinal
homes%>%
  filter(!is.na(SalePrice))%>%
  group_by(Fence) %>%
  dplyr::summarise(median = median(SalePrice), counts=n())

#Fence is not ordinal

#Recode Fence
homes$Fence <- as.factor(homes$Fence)

#Missingness FireplaceQu
homes$FireplaceQu[is.na(homes$FireplaceQu)] <- "No"

#Checking if FireplaceQu is ordinal
homes%>%
  filter(!is.na(SalePrice))%>%
  group_by(FireplaceQu) %>%
  dplyr::summarise(median = median(SalePrice), counts=n())

#Recode FireplaceQu
homes$FireplaceQu<-as.integer(plyr::revalue(homes$FireplaceQu, ordinal_scale))


#LotFrontage is the linear feet of street connnected to property
#Missing values will be replaced by neighborhood average

for (i in 1:nrow(homes)){
        if(is.na(homes$LotFrontage[i])){
               homes$LotFrontage[i] <-
                 as.integer(median(homes$LotFrontage[homes$Neighborhood==homes$Neighborhood[i]], na.rm=TRUE)) 
        }
}

#Missingness GarageType
homes$GarageType[is.na(homes$GarageType)] <- "No"

#Recode GarageType
homes$GarageType <- as.factor(homes$GarageType)

#Checking if GarageFinish is ordinal
homes%>%
  filter(!is.na(SalePrice))%>%
  group_by(GarageFinish) %>%
  dplyr::summarise(median = median(SalePrice), counts=n())

#It is ordinal

#Missingness GarageFinish
homes$GarageFinish[is.na(homes$GarageFinish)] <- "No"

#GarageFinish ordinal vector
Finish <- c('No'=0, 'Unf'=1, 'RFn'=2, 'Fin'=3)

#Recode GarageFinish
homes$GarageFinish<-as.integer(plyr::revalue(homes$GarageFinish, Finish))
table(homes$GarageFinish)

#Missingness GarageQual
homes$GarageQual[is.na(homes$GarageQual)] <- "No"

#Recode GarageQual
homes$GarageQual<-as.integer(plyr::revalue(homes$GarageQual, ordinal_scale))

#Missingness GarageCond
homes$GarageCond[is.na(homes$GarageCond)] <- "No"

#Recode GarageCond
homes$GarageCond<-as.integer(plyr::revalue(homes$GarageCond, ordinal_scale))


#Missingness GarageYrBlt will be substituted for YearBuilt

#For all rows in homes
for (i in 1:nrow(homes)){
  #If observation i of column GarageYrBlt is NA
        if(is.na(homes$GarageYrBlt[i])){
          #Change observation for observation i of column YearBuilt
               homes$GarageYrBlt[i] <- homes$YearBuilt[i] 
        }
}

#Checking if BsmtExposure is ordinal
homes%>%
  filter(!is.na(SalePrice))%>%
  group_by(BsmtExposure) %>%
  dplyr::summarise(median = median(SalePrice), counts=n())

#Missingness BsmtExposure
homes$BsmtExposure[is.na(homes$BsmtExposure)] <- "None"

#It is ordinal, create vector substitute vector
exposure_ordinal <- c("Gd"= 4,"Av"= 3,"Mn"=2,"No"=1, "None"=0)

#Recode BsmtExposure
homes$BsmtExposure<-as.integer(plyr::revalue(homes$BsmtExposure, exposure_ordinal))
table(homes$BsmtExposure)

#Checking if BsmtFinType2 is ordinal
homes%>%
  filter(!is.na(SalePrice))%>%
  group_by(BsmtFinType2) %>%
  dplyr::summarise(median = median(SalePrice), counts=n())

#Missingness BsmtFinType2
homes$BsmtFinType2[is.na(homes$BsmtFinType2)] <- "No"

#It is ordinal, create vector substitute vector
FinType_ordinal <- c('No'=0, 'Unf'=1, 'LwQ'=2, 'Rec'=3, 'BLQ'=4, 'ALQ'=5, 'GLQ'=6)

#Recode BsmtFinType2
homes$BsmtFinType2<-as.integer(plyr::revalue(homes$BsmtFinType2, FinType_ordinal))
table(homes$BsmtFinType2)

#Missingness BsmtQual
homes$BsmtQual[is.na(homes$BsmtQual)] <- "No"

#Recode BsmtQual
homes$BsmtQual<-as.integer(plyr::revalue(homes$BsmtQual, ordinal_scale))

#Missingness BsmtCond
homes$BsmtCond[is.na(homes$BsmtCond)] <- "No"

#Recode BsmtCond
homes$BsmtCond<-as.integer(plyr::revalue(homes$BsmtCond, ordinal_scale))

#Missingness BsmtFinType1
homes$BsmtFinType1[is.na(homes$BsmtFinType1)] <- "No"

#Recode BsmtFinType1
homes$BsmtFinType1<-as.integer(plyr::revalue(homes$BsmtFinType1, FinType_ordinal))
table(homes$BsmtFinType1)

#Checking if MasVnrType is ordinal
homes%>%
  filter(!is.na(SalePrice))%>%
  group_by(MasVnrType) %>%
  dplyr::summarise(median = median(SalePrice), counts=n())

#Missingness MasVnrType
homes$MasVnrType[is.na(homes$MasVnrType)] <- "None"

#Create ordinality vector
mas_ordinality <- c('None'=0, 'BrkCmn'=0, 'BrkFace'=1, 'Stone'=2)

#Recode MasVnrType
homes$MasVnrType<-as.integer(plyr::revalue(homes$MasVnrType, mas_ordinality))
table(homes$MasVnrType)

#Missingness MasVnrArea
homes$MasVnrArea[is.na(homes$MasVnrArea)] <- 0

#Missingness Electrical
homes%>%
  group_by(Electrical)%>%
  dplyr::count()%>%
  arrange(desc(n))%>%
  dplyr::select(Electrical)%>%
  head(n=1)->replacement_Electrical

homes$Electrical[is.na(homes$Electrical)] <- unlist(replacement_Electrical)

#Recode Electrical
homes$Electrical <- as.factor(homes$Electrical)

#Recode MSZoning 
homes$MSZoning  <- as.factor(homes$MSZoning)

#Recode MSSubClass
homes$MSSubClass  <- as.factor(homes$MSSubClass)

#Recode Street     
homes$Street  <- as.factor(homes$Street)

#Recode LotShape   

homes$LotShape   <- as.factor(homes$LotShape)

#Recode LandContour   

homes$LandContour   <- as.factor(homes$LandContour)


#Recode Utilities 

homes$Utilities    <- as.factor(homes$Utilities)

#Recode LotConfig    

homes$LotConfig     <- as.factor(homes$LotConfig)

#Recode LandSlope  

homes$LandSlope     <- as.factor(homes$LandSlope)

#Recode Neighborhood    

homes$Neighborhood     <- as.factor(homes$Neighborhood)

#Recode Condition1   

homes$Condition1     <- as.factor(homes$Condition1)


#Recode Condition2 

homes$Condition2     <- as.factor(homes$Condition2)

#Recode BldgType    

homes$BldgType      <- as.factor(homes$BldgType)

#Recode HouseStyle 

homes$HouseStyle       <- as.factor(homes$HouseStyle)

#Recode RoofStyle    

homes$RoofStyle       <- as.factor(homes$RoofStyle)

#Recode RoofMatl   

homes$RoofMatl      <- as.factor(homes$RoofMatl)

#Recode Exterior1st 

homes$Exterior1st       <- as.factor(homes$Exterior1st)

#Recode Exterior2nd     

homes$Exterior2nd       <- as.factor(homes$Exterior2nd)

#Recode ExterQual 

homes$ExterQual<-as.integer(plyr::revalue(homes$ExterQual, ordinal_scale))

#Recode ExterCond    

homes$ExterCond<-as.integer(plyr::revalue(homes$ExterCond, ordinal_scale))

#Recode Foundation    

homes$Foundation      <- as.factor(homes$Foundation)

#Recode Heating 

homes$Heating       <- as.factor(homes$Heating)

#Recode HeatingQC    

homes$HeatingQC<-as.integer(plyr::revalue(homes$HeatingQC, ordinal_scale))

#Recode CentralAir   

boolean <- c("Y"=1,"N"=0)

homes$CentralAir<-as.integer(plyr::revalue(homes$CentralAir, boolean))

table(homes$CentralAir)

#Recode KitchenQual   


homes$KitchenQual<-as.integer(plyr::revalue(homes$KitchenQual, ordinal_scale))


#Recode Functional    

homes$Functional      <- as.factor(homes$Functional)

#Recode PavedDrive 

homes$PavedDrive       <- as.factor(homes$PavedDrive)

#Recode SaleType 
homes$SaleType        <- as.factor(homes$SaleType)

#Recode SaleCondition 

homes$SaleCondition     <- as.factor(homes$SaleCondition)
```

```{r create time variables}
homes<-homes%>%
  #Mutate to create `YearsSinceBuilt`, `YearsSinceGarageBuilt`, and `YearsSinceRemod`
  #It will be the difference of the present year - YearBuilt
  mutate(YearsSinceBuilt = year(Sys.Date())-YearBuilt,
         #Same for YearsSinceRemod
         YearsSinceRemod = year(Sys.Date())-YearRemodAdd,
         #Same for GarageYrBlt
         YearsSinceGarageBuilt = year(Sys.Date())-GarageYrBlt)%>%
  #Remove `YearsSinceBuilt`, `YearsSinceGarageBuilt`, and `YearsSinceRemod`
  dplyr::select(-YearBuilt,
         -YearRemodAdd,
         -GarageYrBlt,
         -Id)
```

```{r create dummy variables}
#Select factor variables
homes_factor <- homes %>%
  dplyr::select_if(is.factor)

#Create dummy dataframe
homes_dummies <- dummy.data.frame(homes_factor)

#Bind numeric and dummy variables

all_homes <- homes%>%
  select_if(is.numeric)%>%
  cbind(homes_dummies)

```


```{r correlations-table}
complete_cor <- all_homes%>%
#Compute correlation of complete observations
   cor(use = "pairwise.complete.obs")

#Make the correlation matrix a tibble
complete_cor_tibble <- as.tibble(as.table(complete_cor))

complete_cor_tibble %>%
  #Sort the tibble by descending correlations
  arrange(desc(n))%>%
  #Filter variables that have an absolute value correlation higher than 0.5 with SalePrice
  filter(Var1=="SalePrice"&abs(n)>0.5&Var2!="SalePrice")%>%
  #dplyr::select variable and correlation
  dplyr::select(Var2,n)%>%
  #Make table
  kable(caption="Top 16 correlations with SalePrice",
        #Add column names
        col.names = c("Variable","Correlation")) %>%
  #Style table
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

# Data exploration

First we will check that there is no multicolinearity amongst highly correlated variables. *explain here what is multicolinearity*.

```{r checking for multicolinearity}
#Make a simple model
simple_model <- lm(SalePrice ~ OverallQual +
GrLivArea   +
ExterQual   +
KitchenQual +
GarageCars  +
GarageArea  +
TotalBsmtSF +
X1stFlrSF   +
BsmtQual    +
FullBath    +
GarageFinish +
TotRmsAbvGrd +
FireplaceQu +
YearsSinceRemod +
YearsSinceGarageBuilt+
YearsSinceBuilt , data = all_homes)

#Checking for multicolinearity
vif(simple_model)
```

Variables with a vif above 5 are multicolinear with other explanatory variables. These were `GrLiveArea`, `GarageCars`, and `TotalBsmtSF`.

```{r corrected model}
#Make a corrected_model
corrected_model <- lm(SalePrice ~ OverallQual +
ExterQual   +
KitchenQual +
GarageArea  +
X1stFlrSF   +
BsmtQual    +
FullBath    +
GarageFinish +
TotRmsAbvGrd +
FireplaceQu +
YearsSinceRemod +
YearsSinceGarageBuilt +
YearsSinceBuilt , data = all_homes)


#Checking for multicolinearity
vif(corrected_model)
```

After removing predictors that were related amongst themselves, the top 13 variables most (above 0.5) correlated with `SalesPrice` were: 

**Positive correlation**

- `OverallQual`: Rates the overall material and finish of the house
- `ExterQual`: Exterior quality
- `KitchenQual`: Kitchen quality
- `GarageArea`: Size of garage in square feet
- `X1stFlrSF`: First floor square feet
- `BsmtQual`: Height of basement
- `FullBath`: Full bathrooms above grade
- `GarageFinish`: Interior finish of the garage
- `TotRmsAbvGrd`: Total rooms above grade (does not include bathrooms)
- `FireplaceQu`: Fireplace quality

**Negative correlation**

- `YearsSinceRemod`: Years since remodel date (same as construction date if no remodelling or additions)
- `YearsSinceGarageBuilt`: Years since the garage was built 
- `YearsSinceBuilt`: Years since construction date

**Numeric variables**
```{r select significant numeric variables}
#select significant variables
high_cor_vars <- all_homes%>%
  dplyr::select(GarageArea,
                X1stFlrSF,
                YearsSinceRemod,
                YearsSinceGarageBuilt, 
                YearsSinceBuilt)

#Create name list of high_cor_vars
names_high_cor_vars <- names(high_cor_vars)
```

```{r high-cor-geompoint} 

#For each variable that is highly correlated
for (var in names_high_cor_vars){
  
#ggplot with the dataframe with values
plot <- ggplot(high_cor_vars, aes_string(x=var, y=all_homes$SalePrice))+
#geom_point to see distribution
    geom_jitter(alpha=0.1)+
#Add labels
    labs(title=paste("Sales price vs.",var),
       x=var,
       y="Sales price")+ 
  theme_minimal()+
#Add neat scales for price
scale_y_continuous(breaks= seq(0, 800000, by=100000),
                   labels = comma)

#Print the plot after each loop
print(plot)

}

```

**Categorical variables**

```{r high-cor-factors}
#Save column names
cols <- c("OverallQual", "ExterQual", "KitchenQual", "BsmtQual", "FullBath", "GarageFinish", "TotRmsAbvGrd", "FireplaceQu")

#Convert OverallQual, FullBath and TotRmsAbvGrd to a factor
high_cor_vars[cols] <- lapply(all_homes[cols], factor)

```

```{r plotting categorical variables}

#Select significant numeric values
high_cor_vars_fact <- high_cor_vars%>%
  dplyr::select(cols)


#Create name list of high_cor_vars
names_high_cor_vars_fact <- names(high_cor_vars_fact)

#For each variable that is highly correlated
for (var in names_high_cor_vars_fact){
  
#ggplot with the dataframe with values
plot <- ggplot(high_cor_vars_fact, aes_string(x=var, y=all_homes$SalePrice))+
#geom_point to see distribution
    geom_boxplot(alpha=0.1)+
#Add labels
    labs(title=paste("Sales price vs.",var),
       x=var,
       y="Sales price") + theme_minimal() +
#Add neat scales for price
scale_y_continuous(breaks= seq(0, 800000, by=100000),
                   labels = comma)

#Print the plot after each loop
print(plot)

} 

```


# Techniques used

- I 

# Questions from this analysis

- 

